(()=>{"use strict";const e=window.React,t=window.wc.wcBlocksRegistry,n=window.wp.i18n,a=window.wc.wcSettings,o=window.wp.htmlEntities,r=window.wp.element,s="dnapayments_apple_pay",c="woocommerce-gateway-dna",i=({messages:t=[]})=>t.map(((t,n)=>(0,e.createElement)("div",{className:"wc-block-components-notice-banner is-error",key:n},t))),d=window.wp.data;function l(e,{billing:t}){return e/10**t.currency.minorUnit}function m(e){return{firstName:e.first_name,lastName:e.last_name,addressLine1:e.address_1,addressLine2:e.address_2,city:e.city,postalCode:e.postcode,phone:e.phone,country:e.country}}function p(){const{CHECKOUT_STORE_KEY:e}=window.wc.wcBlocksData;return(0,d.select)(e).getOrderId()}async function u(e){const t=function(e){const{billing:t,shippingData:n}=e,{terminalId:o}=(()=>{const e=(0,a.getPaymentMethodData)("dnapayments",{});return{isTestMode:e.is_test_mode,integrationType:e.integration_type,tempToken:e.temp_token,terminalId:e.terminal_id,allowSavingCards:e.allow_saving_cards,sendCallbackEveryFailedAttempt:Number(e.send_callback_every_failed_attempt),cards:e.cards,cardSchemeIconPath:e.card_scheme_icon_path}})();return{invoiceId:p(),amount:l(t.cartTotal.value,e),customerDetails:{email:t.billingAddress.email,accountDetails:{accountId:t.customerId?String(t.customerId):void 0},billingAddress:m(t.billingAddress),deliveryDetails:{deliveryAddress:m(n.shippingAddress)}},paymentSettings:{terminalId:o}}}(e),n=new FormData;n.append("order_id",t.invoiceId),n.append("total",t.amount);const o=await fetch("/wp-admin/admin-ajax.php?action=get_payment_and_auth_data",{method:"POST",body:n}),r=await o.json();return{auth:r.auth,paymentData:{...r.paymentData,...t,invoiceId:r.paymentData.invoiceId,paymentSettings:r.paymentData.paymentSettings}}}function y(e){const t=g();t&&(e?t.setAttribute("disabled","disabled"):t.removeAttribute("disabled"))}function g(){return document.querySelector("button.wc-block-components-checkout-place-order-button")}const w=({containerId:t,componentInstance:a,gatewayId:o,errorMessage:s,props:d})=>{const{components:{LoadingMask:l}}=d,[m,p]=(0,r.useState)("idle"),[w,_]=(0,r.useState)([]),b=(0,r.useRef)(null),h=(0,r.useRef)(),{emitResponse:E,eventRegistration:{onPaymentSetup:f}}=d;return(0,r.useEffect)((()=>f((async()=>h.current?.success?{type:E.responseTypes.SUCCESS,meta:{paymentMethodData:{[`wc-${o}-result`]:JSON.stringify(h.current)}}}:{type:E.responseTypes.ERROR,message:(0,n.__)("Your payment proccess has been failed.",c),messageContext:E.noticeContexts.PAYMENTS}))),[f,E]),(0,r.useEffect)((()=>{b.current&&a&&(async()=>{p("loading");const{paymentData:e,auth:t}=await u(d);h.current=null,b.current.innerHTML="",a.create(b.current,e,{onClick:()=>{p("loading")},onPaymentSuccess:e=>{p("done"),function(...e){console.log(...e)}("onPaymentSuccess",e),h.current=e,function(){const e=g();e&&(e.removeAttribute("disabled"),e.click())}()},onCancel:()=>{p("done")},onError:e=>{!function(e){console.error("CODE",e.code,"MESSAGE",e.message),console.error(e)}("onError");let t=e.message||(0,n.__)("Your card has not been authorised, please check the details and retry or contact your bank.",c);!s||1002!==e.code&&1003!==e.code||(t=s),p("failed"),_([t])},onLoad:()=>{p("done")}},t.access_token)})()}),[a,b,d.billing.cartTotal.value]),(0,r.useEffect)((()=>(y(!0),()=>y(!1))),[]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)(i,{messages:w}),(0,e.createElement)(l,{isLoading:"loading"===m,showSpinner:!0},(0,e.createElement)("div",{ref:b,id:t})))};var _;const b=(0,a.getPaymentMethodData)(s,{}),h=(0,n.__)("Apple Pay",c),E=(0,o.decodeEntities)(b?.title||"")||h,f=b?.icon,S={name:s,label:(0,e.createElement)((t=>{const{PaymentMethodLabel:n}=t.components;return(0,e.createElement)("span",{style:{width:"100%"}},(0,e.createElement)(n,{text:E}),f&&(0,e.createElement)("img",{src:f,style:{float:"right",marginRight:20}}))}),null),content:(0,e.createElement)((t=>(0,e.createElement)(w,{componentInstance:window.DNAPayments.ApplePayComponent,gatewayId:s,containerId:"dnapayments_apple_pay_container",errorMessage:(0,n.__)("Apple Pay payments are not supported in your current browser. Please use Safari on a compatible Apple device to complete your transaction.",c),props:t})),null),edit:(0,e.createElement)((t=>(0,e.createElement)(r.RawHTML,null,(0,o.decodeEntities)(b.description||""))),null),canMakePayment:()=>!0,ariaLabel:E,supports:{features:null!==(_=b?.supports)&&void 0!==_?_:[]},placeOrderButtonLabel:E};(0,t.registerPaymentMethod)(S)})();